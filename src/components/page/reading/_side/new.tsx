// src/components/page/reading/_side/new.tsx
// ÏµúÏ¢Ö ÏàòÏ†ï Î≤ÑÏ†Ñ

import { FlashList } from '@shopify/flash-list';
import { isEmpty } from 'lodash';
import { Center, Text, Box } from 'native-base';
import { memo, useCallback, useEffect, useState, useMemo } from 'react';
import { TouchableOpacity, View } from 'react-native';
import Icon from 'react-native-vector-icons/MaterialIcons';
import { useBaseStyle, useNativeNavigation } from '../../../../hooks';
import { NewBibleStep } from '../../../../utils/define';
import { defaultStorage } from '../../../../utils/mmkv';
import { useBibleReading } from "../../../../utils/useBibleReading";
import FastImage from "react-native-fast-image";

interface Props {
    readState: any;
    menuIndex: number;
}

function NewTestament({ readState, menuIndex }: Props) {
    // üî• Í∞ïÌôîÎêú ÏïàÏ†ÑÏû•Ïπò
    const baseStyleResult = useBaseStyle();
    const color = baseStyleResult?.color || {
        white: '#FFFFFF',
        black: '#000000',
        gray: '#808080',
        gray2: '#E0E0E0',
        primary: '#37C4B9',
        status: '#F0F0F0',
        bible: '#37C4B9'
    };

    const { navigation } = useNativeNavigation();

    // üî• useBibleReading ÌõÖ ÏïàÏ†ÑÏû•Ïπò Ï†ÅÏö©
    const bibleReadingHook = useBibleReading(readState);
    const {
        planData = null,
        isChapterReadSync = null,
        getChapterStatus = null,
        getChapterStyleWithExclamation = null,
        loadPlan = () => {},
        loadAllReadingTableData = () => {},
        refreshKey = 0,
        forceRefresh = () => {},
        readingTableData = {},
        getTodayProgress = null,
        getYesterdayProgress = null
    } = bibleReadingHook || {};

    const [visibleChapters, setVisibleChapters] = useState<Set<string>>(new Set());

    // üî• ÌëúÏãúÌï† Ïû•Îì§ ÏóÖÎç∞Ïù¥Ìä∏ - ÏïàÏ†ÑÏû•Ïπò Í∞ïÌôî
    const updateVisibleChapters = useCallback(() => {
        if (!planData) {
            setVisibleChapters(new Set());
            return;
        }

        try {
            const chaptersToShow = new Set<string>();

            // Ïò§Îäò ÏùΩÏùÑ Ïû•Îì§ Ï∂îÍ∞Ä
            if (getTodayProgress) {
                try {
                    const todayProgress = getTodayProgress();
                    if (todayProgress && todayProgress.remainingChapters) {
                        todayProgress.remainingChapters.forEach(chapter => {
                            if (chapter.bookIndex >= 40 && chapter.bookIndex <= 66) { // Ïã†ÏïΩÎßå
                                chaptersToShow.add(`${chapter.bookIndex}_${chapter.chapter}`);
                            }
                        });
                    }
                } catch (error) {
                    console.warn('getTodayProgress Ìò∏Ï∂ú Ï§ë Ïò§Î•ò:', error);
                }
            }

            // Ïñ¥Ï†ú Î™ª ÏùΩÏùÄ Ïû•Îì§ Ï∂îÍ∞Ä
            if (getYesterdayProgress) {
                try {
                    const yesterdayProgress = getYesterdayProgress();
                    if (yesterdayProgress && yesterdayProgress.missedChapters) {
                        yesterdayProgress.missedChapters.forEach(chapter => {
                            if (chapter.bookIndex >= 40 && chapter.bookIndex <= 66) { // Ïã†ÏïΩÎßå
                                chaptersToShow.add(`${chapter.bookIndex}_${chapter.chapter}`);
                            }
                        });
                    }
                } catch (error) {
                    console.warn('getYesterdayProgress Ìò∏Ï∂ú Ï§ë Ïò§Î•ò:', error);
                }
            }

            setVisibleChapters(chaptersToShow);
            console.log('NewTestament - ÌëúÏãúÌï† Ïû•Îì§ ÏóÖÎç∞Ïù¥Ìä∏:', chaptersToShow.size, 'Í∞ú');
        } catch (error) {
            console.error('ÌëúÏãúÌï† Ïû• ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
            setVisibleChapters(new Set());
        }
    }, [planData, getTodayProgress, getYesterdayProgress]);

    // üî• useEffectÎì§ - ÏïàÏ†ÑÏû•Ïπò Ï†ÅÏö©
    useEffect(() => {
        if (!navigation?.addListener) return;

        const unsubscribe = navigation.addListener('focus', () => {
            console.log('=== NewTestament Ìè¨Ïª§Ïä§ Ïù¥Î≤§Ìä∏ ===');
            if (forceRefresh && typeof forceRefresh === 'function') {
                forceRefresh();
            }
            setTimeout(() => {
                updateVisibleChapters();
            }, 300);
        });

        return unsubscribe;
    }, [navigation, forceRefresh, updateVisibleChapters]);

    useEffect(() => {
        console.log('=== NewTestament readState Î≥ÄÍ≤Ω Í∞êÏßÄ ===', readState?.length || 0);
        updateVisibleChapters();
    }, [readState, updateVisibleChapters]);

    useEffect(() => {
        console.log('=== NewTestament planData Î≥ÄÍ≤Ω Í∞êÏßÄ ===', planData ? planData.planName : 'ÏóÜÏùå');
        updateVisibleChapters();
    }, [planData, updateVisibleChapters]);

    useEffect(() => {
        console.log('=== NewTestament refreshKey Î≥ÄÍ≤Ω Í∞êÏßÄ ===', refreshKey);
        updateVisibleChapters();
    }, [refreshKey, updateVisibleChapters]);

    useEffect(() => {
        console.log('=== NewTestament readingTableData Î≥ÄÍ≤Ω Í∞êÏßÄ ===', Object.keys(readingTableData || {}).length, 'Í∞ú Ìï≠Î™©');
    }, [readingTableData]);

    // üî• Ïä§ÌÉÄÏùº Ìï®Ïàò - ÏôÑÏ†ÑÌïú ÏïàÏ†ÑÏû•Ïπò
    const getChapterStyleLegacy = useCallback((book: number, chapter: number) => {
        const baseStyle = {
            borderRadius: 17.5,
            width: 35,
            height: 35,
            justifyContent: 'center' as const,
            alignItems: 'center' as const,
            borderWidth: 1,
            borderColor: "#E0E0E0",
            backgroundColor: 'transparent',
        };

        try {
            // ÏùΩÍ∏∞ ÏÉÅÌÉú ÌôïÏù∏
            const isRead = isChapterReadSync ? isChapterReadSync(book, chapter) : false;

            if (book === 40 && chapter === 1) {
                console.log(`New: ${book}Í∂å ${chapter}Ïû• ÏùΩÍ∏∞ ÏÉÅÌÉú: ${isRead}, planData: ${planData ? 'exists' : 'null'}`);
            }

            // ÏùΩÏùÄ Ïû•ÏùÄ Ìï≠ÏÉÅ Ï¥àÎ°ùÏÉâ
            if (isRead) {
                return {
                    ...baseStyle,
                    color: '#4CAF50',
                    showExclamation: false
                };
            }

            // ÏùºÎèÖ Í≥ÑÌöçÏù¥ ÏóÜÎäî Í≤ΩÏö∞
            if (!planData) {
                return {
                    ...baseStyle,
                    color: "#000000",
                    showExclamation: false
                };
            }

            // ÏÉÅÌÉú ÌôïÏù∏
            let status = 'normal';
            if (getChapterStatus && typeof getChapterStatus === 'function') {
                try {
                    status = getChapterStatus(planData, book, chapter);
                } catch (error) {
                    console.warn('getChapterStatus Ìò∏Ï∂ú Ï§ë Ïò§Î•ò:', error);
                    status = 'normal';
                }
            }

            // ÏÉÅÌÉúÎ≥Ñ Ïä§ÌÉÄÏùº Î∞òÌôò
            switch (status) {
                case 'today':
                    return {
                        ...baseStyle,
                        color: '#F44336',
                        showExclamation: false
                    };
                case 'yesterday':
                    return {
                        ...baseStyle,
                        color: '#2196F3',
                        showExclamation: true
                    };
                case 'missed':
                    return {
                        ...baseStyle,
                        color: '#333333',
                        showExclamation: true
                    };
                case 'future':
                    return {
                        ...baseStyle,
                        color: '#000000',
                        showExclamation: false
                    };
                default:
                    return {
                        ...baseStyle,
                        color: '#000000',
                        showExclamation: false
                    };
            }
        } catch (error) {
            console.error(`Ïû• Ïä§ÌÉÄÏùº Í≥ÑÏÇ∞ Ïò§Î•ò (${book}:${chapter}):`, error);
            return {
                ...baseStyle,
                color: '#000000',
                showExclamation: false
            };
        }
    }, [isChapterReadSync, planData, getChapterStatus]);

    // üî• Î†åÎçîÎßÅ Ìï®Ïàò - ÏïàÏ†ÑÏû•Ïπò Í∞ïÌôî
    const renderItem = useCallback(({ item }: { item: any }) => {
        if (!item) {
            return <Box key="empty" />;
        }

        return (
            <Box mb={5} key={`new-${item.index}`}>
                <Text fontSize={20} fontWeight="600" color={color?.black || '#000000'} mb={3}>
                    {item.name || ''}
                </Text>
                <View style={{ flexDirection: 'row', flexWrap: 'wrap' }}>
                    {Array.from({ length: item.count || 0 }, (_, chapterIndex) => {
                        const chapter = chapterIndex + 1;

                        let chapterStyle;
                        try {
                            chapterStyle = getChapterStyleLegacy(item.index, chapter);
                        } catch (error) {
                            console.error('Ïä§ÌÉÄÏùº Í≥ÑÏÇ∞ Ïò§Î•ò:', error);
                            chapterStyle = {
                                borderRadius: 17.5,
                                width: 35,
                                height: 35,
                                justifyContent: 'center' as const,
                                alignItems: 'center' as const,
                                borderWidth: 1,
                                borderColor: "#E0E0E0",
                                backgroundColor: 'transparent',
                                color: '#000000',
                                showExclamation: false
                            };
                        }

                        const isVisible = visibleChapters.has(`${item.index}_${chapter}`);

                        return (
                            <TouchableOpacity
                                key={chapter}
                                onPress={() => {
                                    try {
                                        defaultStorage.set("bible_book", item.index);
                                        defaultStorage.set("bible_jang", chapter);
                                        navigation.navigate("BibleConectionScreen");
                                    } catch (error) {
                                        console.error('ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Ïò§Î•ò:', error);
                                    }
                                }}
                                style={{
                                    ...chapterStyle,
                                    margin: 3,
                                    position: 'relative'
                                }}
                            >
                                <Text
                                    style={{
                                        color: chapterStyle.color || '#000000',
                                        fontSize: 14,
                                        fontWeight: isVisible ? 'bold' : 'normal'
                                    }}
                                >
                                    {chapter}
                                </Text>

                                {/* ÎäêÎÇåÌëú ÏïÑÏù¥ÏΩò */}
                                {chapterStyle.showExclamation && isVisible && (
                                    <View
                                        style={{
                                            position: 'absolute',
                                            top: -3,
                                            right: -3,
                                            backgroundColor: '#F44336',
                                            borderRadius: 8,
                                            width: 16,
                                            height: 16,
                                            justifyContent: 'center',
                                            alignItems: 'center'
                                        }}
                                    >
                                        <Icon name="priority-high" size={10} color={color?.white || '#FFFFFF'} />
                                    </View>
                                )}
                            </TouchableOpacity>
                        );
                    })}
                </View>
            </Box>
        );
    }, [getChapterStyleLegacy, visibleChapters, navigation, color]);

    // üî• Î©îÎ™®Ïù¥Ï†úÏù¥ÏÖòÎêú Îç∞Ïù¥ÌÑ∞ - ÏïàÏ†ÑÏû•Ïπò
    const memoizedData = useMemo(() => {
        return Array.isArray(NewBibleStep) ? NewBibleStep : [];
    }, []);

    // Î°úÎî© ÏÉÅÌÉú
    if (isEmpty(memoizedData)) {
        return (
            <Center flex={1} bg={color?.white || '#FFFFFF'}>
                <Text color={color?.black || '#000000'}>Ïã†ÏïΩ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</Text>
            </Center>
        );
    }

    return (
        <Box flex={1} bg={color?.white || '#FFFFFF'} px={4} py={4}>
            <FlashList
                data={memoizedData}
                renderItem={renderItem}
                estimatedItemSize={200}
                keyExtractor={(item) => `new-testament-${item?.index || Math.random()}`}
                extraData={`${refreshKey}-${readState?.length || 0}-${visibleChapters.size}`}
                showsVerticalScrollIndicator={false}
                onError={(error) => {
                    console.error('FlashList Ïò§Î•ò:', error);
                }}
            />
        </Box>
    );
}

export default memo(NewTestament);