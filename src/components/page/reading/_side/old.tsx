import { FlashList } from '@shopify/flash-list';
import { isEmpty } from 'lodash';
import { Center, Text } from 'native-base';
import { memo, useCallback, useEffect, useMemo, useState } from 'react';
import { TouchableOpacity, View } from 'react-native';
import FastImage from "react-native-fast-image";
import { useBaseStyle, useNativeNavigation } from '../../../../hooks';
import { OldBibleStep } from '../../../../utils/define';
import { defaultStorage } from '../../../../utils/mmkv';
import {
    loadBiblePlanData,
    getSafePlanData,
    isChapterRead,
    getChapterStatus,
    getChapterStyleInfo,
    getTodayChapters,
    calculateProgress,
    formatDate
} from '../../../../utils/biblePlanUtils';

interface Props {
    readState: any;
    menuIndex: number;
    filterBooks?: number[];
}

function OldTestament({ readState, menuIndex, filterBooks }: Props) {
    const { color } = useBaseStyle();
    const { navigation } = useNativeNavigation();

    // ÏÉÅÌÉú Í¥ÄÎ¶¨
    const [planData, setPlanData] = useState<any>(null);
    const [refreshKey, setRefreshKey] = useState(0);
    const [todayChapters, setTodayChapters] = useState<any[]>([]);

    // ÏÉâÏÉÅ ÌÖåÎßà Ï†ïÏùò
    const colorTheme = {
        black: "#000000",
        bible: "#4CAF50", // Ï¥àÎ°ùÏÉâ
        blue: "#2196F3",
        red: "#F44336",
        gray: "#9E9E9E",
        white: "#FFFFFF"
    };

    // Í≥ÑÌöç Îç∞Ïù¥ÌÑ∞ Î°úÎìú Î∞è Ïò§Îäò ÏùΩÏùÑ Ïû• Í≥ÑÏÇ∞
    const loadData = useCallback(() => {
        const rawPlanData = loadBiblePlanData();
        const safePlan = getSafePlanData(rawPlanData);
        setPlanData(safePlan);

        if (safePlan) {
            const today = getTodayChapters(safePlan);
            setTodayChapters(today);
            console.log(`OldTestament - Ïò§Îäò ÏùΩÏùÑ Ïû•: ${today.length}Í∞ú`);
        }
    }, []);

    // Í∞ïÏ†ú ÏÉàÎ°úÍ≥†Ïπ®
    const forceRefresh = useCallback(() => {
        setRefreshKey(prev => prev + 1);
        loadData();
    }, [loadData]);

    // Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Î∞è Ìè¨Ïª§Ïä§ Ïù¥Î≤§Ìä∏
    useEffect(() => {
        loadData();

        const unsubscribe = navigation.addListener('focus', () => {
            console.log('=== OldTestament Ìè¨Ïª§Ïä§ Ïù¥Î≤§Ìä∏ ===');
            forceRefresh();
        });

        return unsubscribe;
    }, [navigation, forceRefresh, loadData]);

    // readState Î≥ÄÍ≤Ω Í∞êÏßÄ
    useEffect(() => {
        console.log('=== OldTestament readState Î≥ÄÍ≤Ω Í∞êÏßÄ ===', readState?.length || 0);
        forceRefresh();
    }, [readState, forceRefresh]);

    // Ïû• Ïä§ÌÉÄÏùº Í∞ÄÏ†∏Ïò§Í∏∞
    const getChapterStyle = useCallback((book: number, chapter: number) => {
        // Í∏∞Î≥∏ Ïä§ÌÉÄÏùº
        const baseStyle = {
            borderRadius: 17.5,
            width: 35,
            height: 35,
            justifyContent: 'center' as const,
            alignItems: 'center' as const,
            borderWidth: 1,
            borderColor: "#E0E0E0",
            backgroundColor: 'transparent',
        };

        try {
            // ÏùΩÍ∏∞ ÏÉÅÌÉú ÌôïÏù∏
            const read = isChapterRead(planData, book, chapter);

            // ÎîîÎ≤ÑÍπÖÏö© Î°úÍ∑∏ (Ï∞ΩÏÑ∏Í∏∞ 1Ïû•Îßå)
            if (book === 1 && chapter === 1) {
                console.log(`Old: Ï∞ΩÏÑ∏Í∏∞ 1Ïû• - read: ${read}, planData: ${planData ? planData.planType : 'null'}`);
            }

            // ÏùΩÏùÄ Ïû•ÏùÄ Ìï≠ÏÉÅ Ï¥àÎ°ùÏÉâ
            if (read) {
                return {
                    style: {
                        ...baseStyle,
                        borderColor: '#4CAF50',
                        backgroundColor: 'transparent',
                    },
                    color: '#4CAF50', // Ï¥àÎ°ùÏÉâ
                    showExclamation: false,
                    priority: 1,
                    statusText: 'ÏùΩÏùå'
                };
            }

            // ÏùºÎèÖ Í≥ÑÌöçÏù¥ ÏóÜÎäî Í≤ΩÏö∞ - ÏùΩÏßÄ ÏïäÏùÄ Ïû•ÏùÄ Í≤ÄÏ†ïÏÉâ
            if (!planData) {
                return {
                    style: {
                        ...baseStyle,
                        borderColor: "#000000",
                        backgroundColor: 'transparent',
                    },
                    color: "#000000",
                    showExclamation: false,
                    priority: 0,
                    statusText: 'ÏùΩÏßÄ ÏïäÏùå'
                };
            }

            // ÏùºÎèÖ Í≥ÑÌöçÏù¥ ÏûàÎäî Í≤ΩÏö∞ - Í≥ÑÌöç ÌÉÄÏûÖÎ≥ÑÎ°ú ÏÉÅÌÉú ÌôïÏù∏
            let status = 'normal';

            // Í≥ÑÌöç ÌÉÄÏûÖÏóê Îî∞Îùº ÏÉÅÌÉú ÌôïÏù∏
            if (planData.planType === 'psalms' && book === 19) {
                status = getChapterStatus(planData, book, chapter);
            } else if (planData.planType === 'pentateuch' && book >= 1 && book <= 5) {
                status = getChapterStatus(planData, book, chapter);
            } else if (planData.planType === 'old_testament' && book >= 1 && book <= 39) {
                status = getChapterStatus(planData, book, chapter);
            } else if (planData.planType === 'full_bible') {
                status = getChapterStatus(planData, book, chapter);
            }

            // ÎîîÎ≤ÑÍπÖÏö© Î°úÍ∑∏
            if ((book === 19 && chapter === 1 && planData.planType === 'psalms') ||
                (book === 1 && chapter === 1 && planData.planType === 'pentateuch')) {
                console.log(`üîç Debug - ${book}Í∂å ${chapter}Ïû•: planType=${planData.planType}, status=${status}`);
            }

            // ÏÉÅÌÉúÎ≥Ñ ÏÉâÏÉÅ Î∞òÌôò
            switch (status) {
                case 'today':
                    return {
                        style: {
                            ...baseStyle,
                            borderColor: '#F44336',
                            backgroundColor: 'transparent',
                        },
                        color: '#F44336', // Îπ®Í∞ÑÏÉâ (Ïò§Îäò ÏùΩÏùÑ Ïû•)
                        showExclamation: false,
                        priority: 4,
                        statusText: 'Ïò§Îäò ÏùΩÏùÑ Ïû•'
                    };
                case 'yesterday':
                    return {
                        style: {
                            ...baseStyle,
                            borderColor: '#2196F3',
                            backgroundColor: 'transparent',
                        },
                        color: '#2196F3', // ÌååÎûÄÏÉâ (Ïñ¥Ï†ú ÏùΩÏñ¥Ïïº ÌñàÎçò Ïû•)
                        showExclamation: true,
                        priority: 3,
                        statusText: 'Ïñ¥Ï†ú ÏùΩÏñ¥Ïïº ÌñàÎçò Ïû•'
                    };
                case 'missed':
                    return {
                        style: {
                            ...baseStyle,
                            borderColor: '#333333',
                            backgroundColor: 'transparent',
                        },
                        color: '#333333', // ÏßÑÌïú ÌöåÏÉâ (ÎÜìÏπú Ïû•)
                        showExclamation: true,
                        priority: 2,
                        statusText: 'ÎÜìÏπú Ïû•'
                    };
                default:
                    return {
                        style: {
                            ...baseStyle,
                            borderColor: "#000000",
                            backgroundColor: 'transparent',
                        },
                        color: "#000000", // Í≤ÄÏ†ïÏÉâ (ÎØ∏Îûò Ïû• Îì±)
                        showExclamation: false,
                        priority: 0,
                        statusText: 'ÏùΩÏßÄ ÏïäÏùå'
                    };
            }
        } catch (error) {
            console.error('Ïû• Ïä§ÌÉÄÏùº Í≥ÑÏÇ∞ Ïò§Î•ò:', error);
            return {
                style: baseStyle,
                color: colorTheme.black,
                showExclamation: false,
                priority: 0,
                statusText: 'ÏùΩÏßÄ ÏïäÏùå'
            };
        }
    }, [planData, colorTheme]);

    // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Ï≤òÎ¶¨
    const onNavigate = useCallback((book: number, chapter: number) => {
        try {
            defaultStorage.set('bible_book_connec', book);
            defaultStorage.set('bible_jang_connec', chapter);

            navigation.navigate(
                'BibleConectionScreen',
                menuIndex === 1 ? { sound: true } : { show: true }
            );
        } catch (error) {
            console.error('ÌôîÎ©¥ Ïù¥Îèô Ïò§Î•ò:', error);
        }
    }, [navigation, menuIndex]);

    // Î†åÎçîÎßÅ ÏïÑÏù¥ÌÖú Ïª¥Ìè¨ÎÑåÌä∏
    const RenderItems = useCallback(
        ({ book, title, length }: { book: number; title: string; length: number }) => {
            // ÌïÑÌÑ∞ÎßÅ Ï≤¥ÌÅ¨
            if (filterBooks && !filterBooks.includes(book)) {
                return null;
            }

            return (
                <View key={`${book}-${refreshKey}`}>
                    <Center>
                        <Text
                            fontSize={'18px'}
                            fontWeight={'bold'}
                            marginTop={5}
                            marginBottom={5}
                        >
                            {title}
                        </Text>
                    </Center>
                    <View
                        style={{
                            flexDirection: 'row',
                            flexWrap: 'wrap',
                            width: '100%',
                            padding: 12,
                            justifyContent: 'center'
                        }}
                    >
                        {Array.from({ length }).map((_, index) => {
                            const chapter = index + 1;
                            const chapterStyleInfo = getChapterStyle(book, chapter);
                            const isRead = isChapterRead(planData, book, chapter);
                            const status = getChapterStatus(planData, book, chapter);

                            return (
                                <TouchableOpacity
                                    key={`${book}-${chapter}-${refreshKey}-${isRead ? 'read' : 'unread'}`}
                                    activeOpacity={0.7}
                                    style={{
                                        margin: 2,
                                        position: 'relative'
                                    }}
                                    onPress={() => onNavigate(book, chapter)}
                                >
                                    {/* Ïû• Î≤àÌò∏ Î≤ÑÌäº */}
                                    <View style={chapterStyleInfo.style}>
                                        <Text
                                            textAlign={'center'}
                                            style={{
                                                color: chapterStyleInfo.color,
                                                fontSize: 14,
                                                fontWeight: status === 'today' ? 'bold' : 'normal'
                                            }}
                                        >
                                            {chapter}
                                        </Text>
                                    </View>

                                    {/* ÎäêÎÇåÌëú ÏïÑÏù¥ÏΩò */}
                                    {chapterStyleInfo.showExclamation && (
                                        <View
                                            style={{
                                                position: 'absolute',
                                                top: -4,
                                                right: -4,
                                                width: 20,
                                                height: 20,
                                                justifyContent: 'center',
                                                alignItems: 'center',
                                            }}
                                        >
                                            <FastImage
                                                source={require('../../../../assets/img/noRead.png')}
                                                style={{
                                                    width: 16,
                                                    height: 16,
                                                }}
                                                resizeMode={FastImage.resizeMode.contain}
                                            />
                                        </View>
                                    )}
                                </TouchableOpacity>
                            );
                        })}
                    </View>
                </View>
            );
        },
        [getChapterStyle, planData, onNavigate, refreshKey, filterBooks]
    );

    // Îç∞Ïù¥ÌÑ∞ Î©îÎ™®Ïù¥Ï†úÏù¥ÏÖò
    const filteredData = useMemo(() => {
        return filterBooks
            ? OldBibleStep.filter(book => filterBooks.includes(book.index))
            : OldBibleStep;
    }, [filterBooks]);

    return (
        <FlashList
            renderItem={({ item }) => {
                return (
                    <RenderItems
                        book={item.index}
                        length={item.count}
                        title={item.name}
                    />
                );
            }}
            showsHorizontalScrollIndicator={true}
            estimatedItemSize={66}
            data={filteredData}
            extraData={`${refreshKey}-${planData?.planName || 'no-plan'}-${readState?.length || 0}`}
            keyExtractor={(item) => `${item.index}-${refreshKey}`}
        />
    );
}

export default memo(OldTestament);